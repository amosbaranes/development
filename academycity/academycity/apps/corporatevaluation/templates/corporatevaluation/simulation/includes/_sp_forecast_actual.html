{% load static i18n cms_tags menu_tags sekizai_tags thumbnail %}
{% load core_tags %}

<div id="sp_forecast_actual" class="tabcontent data">
</div>

<!--  get_earning_forecast_sp500_view -->
<script>
function get_earning_forecast_sp500_view()
{
  if (vObj["earning_forecast_sp500_view_downloaded"] == 1){return;}
  message_div = document.getElementById("sp_forecast_actual")
  message_div.innerHTML = 'In process .. '

  $.post('{% url "corporatevaluation:admin_setup" %}',
      {
        fun: "get_earning_forecast_sp500_view",
      },
      function(data){
            message_div.innerHTML = 'Process done with status: ' + data['status']
            vObj["earning_forecast_sp500_view_downloaded"] = 1;
            create_table_for_earning_forecast_sp500(data=data['earning_forecast_sp500_view']) ;
      }
    );
}
</script>

<!-- create_table_for_earning_forecast_sp500 -->
<script>
function create_table_for_earning_forecast_sp500(data)
{
 //first_ticker = Object.keys(data)[0]
 var s_title1 = "<tr><td style='text-align:center' colspan='3'>Year</td>";
 var s_title2 = "<tr><td style='text-align:center' colspan='3'>Qt</td>";
 var s_title3 = "<tr><td>NextR.Date</td><td>#</td><td style='text-align:center'>Ticker</td>";
 var s_body = "";
 var y_max = 0; var q_max = 0; var y_min = 10000; var q_min = 4;
 for (t in data)
 {
     for (y in data[t])
     {
       if(y >= y_max){y_max = y;for (q in data[t][y]){if(q > q_max){q_max = q}}}
       if(y <= y_min){y_min = y;for (q in data[t][y]){if(q < q_min){q_min = q}}}
     }
 }

//alert(y_max); alert(q_max);alert(y_min); alert(q_min)

 for (y = y_max; y >= y_min ; y--)
 {
   if(y==y_max){nq=q_max*6;q_t=q_max;q_b=1} else if (y==y_min){nq=(4-q_min+1)*6;;q_t=4;q_b=q_min} else {nq = 24;q_t=4;q_b=1}
   //alert(nq); alert(q_t); alert(q_b)
    s_title1 += "<td colspan='"+nq+"' style='text-align:center'>" + y + "</td>"
    for (q = q_t; q >= q_b ; q--)
    {
      s_title2 += "<td  colspan='6' style='text-align:center'>"+q+"</td>";
      s_title3 += "<td style='text-align:center'>For.</td><td style='text-align:center'>Act.</td><td style='text-align:center'>Price</td><td style='text-align:center'>Price(-1)</td><td style='text-align:center'>D</td><td style='text-align:center'>D%</td>"
    }
 }

 //alert(s_title1 + s_title2 + s_title3)
  n=0
 for (t in data)
 {
   n += 1
   var s_body_t = "<td onclick=show_detailed_forecast_data(event) style='cursor:pointer;'>"+n+"</td>"
   s_body_t += "<td onclick='set_ticker_to_valuation(event)' style='cursor:pointer;'>"+t+"</td>" ;

       var s_release = ""
       for (y = y_max; y >= y_min ; y--)
        {
              if(y==y_max){q_t=q_max;q_b=1} else if (y==y_min){q_t=4;q_b=q_min} else {q_t=4;q_b=1}
              for (q = q_t; q >= q_b ; q--)
              {
                  try{
                         if ((data[t][y][q][4] != undefined) && (data[t][y][q][4] != "undefined") && (data[t][y][q][4] != 'None'))
                         {
                           //alert(t + " " + y + " " + q)
                           //alert(data[t][y][q][4])
                            s_release = "<td>"+data[t][y][q][4]+"</td>"
                         }
                         else
                         {
                           if (s_release == ""){s_release = "<td>----</td>"}
                         }
                  } catch (er) {}
                  try{
                     s_body_t += "<td y='"+y+"' q='"+q+"'>"+data[t][y][q][0]+"</td>"
                     s_body_t += "<td>"+data[t][y][q][1]+"</td>"
                     s_body_t += "<td>"+data[t][y][q][2]+"</td>"
                     s_body_t += "<td>"+data[t][y][q][3]+"</td>"
                     nn = parseFloat(data[t][y][q][2]) - parseFloat(data[t][y][q][3])
                     //alert(nn)
                     s_body_t += "<td>"+Math.round(100*nn)/100+"</td>"
                     nn = parseFloat(data[t][y][q][2])/parseFloat(data[t][y][q][3])-1
                     s_body_t += "<td>"+Math.round(10000*nn)/100+"</td>"
                  } catch (er) {s_body_t += "<td></td><td></td><td></td><td></td><td></td><td></td>"}
              }
        }
      s_body += "<tr>" + s_release + s_body_t + "</tr>"
 }
 //alert(s_body)

 s_title1 += "</tr>"
 s_title2 += "</tr>"

 s = "<table>"+s_title1 + s_title2 + s_title3 + s_body + "</table><br/><br/><br/><br/><br/>"
 //alert(s)
 document.getElementById("sp_forecast_actual").innerHTML = s;
}

</script>

<!--  show_detailed_forecast_data  -->
<script>

function show_detailed_forecast_data(event)
{
 elm = event.target; //alert(elm.outerHTML)
 pelm = elm.parentNode; //alert(pelm.outerHTML)
 s1 = "";
 s2 = "<tr><td>Y</td><td>Q</td><td>For.</td><td>Act.</td><td>P</td><td>P(-1)</td><td>D</td><td>D%</td></tr>";

 n = 0
 for (let i = 1; i < pelm.children.length; i++)
 {
  if(i==1){s1+= "<h3>" +pelm.children[i].innerHTML; continue;}
  if(i==2){s1+= ": "+pelm.children[i].innerHTML +"</h3>"; continue;}
  k = (i - 3 - n*6)
  if (i==3) { var q = pelm.children[i].getAttribute("q"); y = y = pelm.children[i].getAttribute("y");}
  if(k>5){k=0; y = pelm.children[i].getAttribute("y"); q = pelm.children[i].getAttribute("q");n+=1 }

  if (y != null) {
   if(k==0){ s2 += "<tr><td>" + y + "</td><td>" + q + "</td>"}
   s2+="<td>"+pelm.children[i].innerHTML+"</td>"
   if(k==5){s2 += "</tr>"}
  }
 }
 s_all = s1 + "<table>" +  s2 + "</table>"
 //alert(s_all)
 ef.set_info_by_ticker(s_all)
}

</script>

<script>
function set_ticker_to_valuation(event)
{
 ticker = event.target.innerHTML
 let search_ticker = document.getElementById("search_ticker")
 search_ticker.value = ticker
 var event = new Event("change", {bubbles: true}); search_ticker.dispatchEvent(event);
}
</script>










