{% load static i18n cms_tags menu_tags sekizai_tags thumbnail %}
{% load core_tags %}
<div class="tabcontent" id="inputs" style="background-color:lightcyan">
    <!-- pick a company and year of valuation -->
    <table>
            <tr>
                <td>{% trans "Industry" %}:</td>
                <td>
                    <select id="industries" name="industries" onChange="industries_fun(event)" style="width: 150px;">
                        <option value='1'>{% trans "All Companies" %}</option>
                        {% for i in industry %}
                        <option value='{{ i.sic_code }}'>{{ i.sic_description }}</option>
                        {% endfor %}
                    </select>
                    Sic Code: <input id="sic_code_" onchange="sic_code_onchange(event)" style="width:70px;line-height: 10px;" value="">
                </td>
            </tr>
            <tr>
                <td>{% trans "Company" %}:</td>
                <td>
                    <select id="companies" name="companies" onChange="companies_fun(event)" style="width: 150px;">
                        <option ticker="" value='0'>Choose company</option>
                        {% for c in companies %}
                        <option ticker="{{c.ticker}}" value='{{c.id}}'>{{c.company_name}}</option>
                        {% endfor %}
                    </select>
                    <span id="ticker_">Ticker: </span>
                    <input id="search_ticker" onchange="ticker_onchange(event)" style="width:70px;line-height: 10px;" value="">
                </td>
            </tr>
            <tr>
                <td>Year:</td>
                <td>
                    <select id="valuation_year" name="valuation_year" onChange="valuation_year_fun(event)"
                            style="width: 150px;">
                        <option value='0'>--------------------</option>
                    </select>
                </td>
            </tr>
    </table>
    <!--  Country Risk  -->
    <hr/>
    Country Risk:
    <label class="radio-inline">
      <input type="radio" name="optradio" onclick="pick_countries_or_regions(event)" id="countries_" value="countries" checked> By Countries
    </label>
    <label class="radio-inline">
      <input type="radio" name="optradio" onclick="pick_countries_or_regions(event)" id="regions_" value="regions"> By Regions
    </label>

    <div id="rp_by_countries_" style="display:block">
        <table class="data" id="rp_countries_" onchange="calc_rp_(event)" oninput="calc_rp_(event)">
        <thead>
        <tr>
            <th>{% trans "Country" %}</th>
            <th>{% trans "Revenues" %}</th>
            <th>{% trans "Rating" %}</th>
            <th>{% trans "Spread" %}</th>
            <th>{% trans "Risk prem." %}</th>
            <th>{% trans "Tax rate" %}</th>
            <th style="padding:0px"><button class="btn" onclick="add_country_risk_premium()" style="color:white"><i class="fa fa-plus"></i></button></th>
        </tr>
        </thead>
        <tbody id="rp_countries_tbody_">
          <tr id="rp_country_row" onchange="rp_input_(event, r='null', region='false')">
            <td>
                <select id="countries" name="countries" onChange="countries_fun(event)" style="width: 150px;" rec_id="-1">
                    <option value='0'>--------------------</option>
                    {% for cd in countries_data %}
                    <option data='{{cd.tax_rate}}_{{cd.moodys_rate_completed_by_sp}}_{{cd.rating_based_default_spread}}_{{cd.country_risk_premium_rating}}'
                            value={{cd.country.id}}>
                        {{cd.country.name}}
                    </option>
                    {% endfor %}
                </select>
            </td>
            <td style="padding:0px"><input id="rp_revenues" style="width:100px;line-height: 10px;text-align: right;" type="text" value=""/></td>
            <td style="padding:0px"><input id="rp_rate" style="width:100px;line-height: 10px;text-align: right;" type="text" value=""/></td>
            <td style="padding:0px"><input id="rp_spread" style="width:100px;line-height: 10px;text-align: right;" type="text" value=""/></td>
            <td style="padding:0px"><input id="rp_risk_premium" style="width:100px;line-height: 10px;text-align: right;" type="text" value=""/></td>
            <td style="padding:0px"><input id="rp_tax_rate" style="width:100px;line-height: 10px;text-align: right;" type="text" value=""/></td>
            <td style="padding:0px"><button class="btn" onclick="delete_rp_for_country_or_region(event)"><i class="fa fa-trash"></i></button></td>
          </tr>
        </tbody>
        </table>
        <span id="rp_default_spread_avg" style="display:inline-block;width: 460px;font-weight: normal;text-align: right"></span>
        <span id="rp_risk_premium_avg" style="display:inline-block;width: 95px;font-weight: normal;text-align: right"></span>
        <span id="rp_tax_rate_avg" style="display:inline-block;width: 98px;font-weight: normal;text-align: right"></span>
    </div>

    <div id="rp_by_regions_" style="display:none">
        <table class="data" id="rp_regions_" onchange="calc_rp_(event)" oninput="calc_rp_(event)">
        <thead>
        <tr>
            <th>{% trans "Region" %}</th>
            <th>{% trans "Revenues" %}</th>
            <th>{% trans "Rating" %}</th>
            <th>{% trans "Spread" %}</th>
            <th>{% trans "Risk prem." %}</th>
            <th>{% trans "Tax rate" %}</th>
            <th style="padding:0px"><button class="btn" onclick="add_region_risk_premium()" style="color:white"><i class="fa fa-plus"></i></button></th>
        </tr>
        </thead>
        <tbody id="rp_regions_tbody_">
          <tr id="rp_region_row" onchange="rp_input_(event, r='null', region='true')">
            <td>
                <select id="regions" name="regions" onChange="regions_fun(event)" style="width: 150px;" rec_id="-1">
                    <option value='0'>--------------------</option>
                    {% for rd in regions_data %}
                    <option data='{{rd.tax_rate}}_{{rd.moodys_rate_completed_by_sp}}_{{rd.rating_based_default_spread}}_{{rd.country_risk_premium_rating}}'
                            value={{rd.region.id}}>
                        {{rd.region.full_name}}
                    </option>
                    {% endfor %}
                </select>
            </td>
            <td style="padding:0px"><input id="rp_revenues" style="width:100px;line-height: 10px;text-align: right;" type="text" value=""/></td>
            <td style="padding:0px"><input id="rp_rate" style="width:100px;line-height: 10px;text-align: right;" type="text" value=""/></td>
            <td style="padding:0px"><input id="rp_spread" style="width:100px;line-height: 10px;text-align: right;" type="text" value=""/></td>
            <td style="padding:0px"><input id="rp_risk_premium" style="width:100px;line-height: 10px;text-align: right;" type="text" value=""/></td>
            <td style="padding:0px"><input id="rp_tax_rate" style="width:100px;line-height: 10px;text-align: right;" type="text" value=""/></td>
            <td style="padding:0px"><button class="btn" onclick="delete_rp_for_country_or_region(event)"><i class="fa fa-trash"></i></button></td>
          </tr>
        </tbody>
        </table>
        <span id="rpr_default_spread_avg" style="display:inline-block;width: 460px;font-weight: normal;text-align: right"></span>
        <span id="rpr_risk_premium_avg" style="display:inline-block;width: 95px;font-weight: normal;text-align: right"></span>
        <span id="rpr_tax_rate_avg" style="display:inline-block;width: 98px;font-weight: normal;text-align: right"></span>
    </div>
    <hr/>
</div>

<!-- delete_industry_beta(event) -->
<script>
function delete_industry_beta(event)
{
 t = event.target
 r = t.parentNode.parentNode.parentNode
 r.parentNode.removeChild(r);
 calculate_all()
}
</script>

<!-- Country risk -->
<!-- pick_countries_or_regions(event) -->
<script>
function pick_countries_or_regions(event)
{
 var e = event.target; var id_ = e.getAttribute("id"); var elm = document.getElementById("rp_by_"+id_);
 elm.style.display = "block";
 if (id_ == "countries_"){elm=document.getElementById("rp_by_regions_");} else {elm=document.getElementById("rp_by_countries_");}
 elm.style.display = "none"
}
</script>

<!-- get_countries_regions_for_year() -->
<script>
function get_countries_regions_for_year()
{
  // --
  var elm = document.getElementById("countries_"); elm.checked = false;
  var elm = document.getElementById("regions_"); elm.checked = false;

  for (y in vObj["countries_regions"])
  {if (y == vObj["valuation_year"])
   {
        for (cr in vObj["countries_regions"][y])
        {
            if (cr == "countries")
            {
                var r = document.getElementById("rp_country_row")
                var n_ = 0
                for (j in vObj["countries_regions"][y][cr])
                {
                  var elm = document.getElementById("countries_"); elm.checked = true;
                  if(n_!=0)
                  {
                   //alert(y + "  " + cr + " : " + j+ "      " + vObj["countries_regions"][y][cr][j])
                   r = add_country_risk_premium();
                  }
                   var e = r.children[0].children[0]; e.value = j;
                   e.setAttribute("rec_id", vObj["countries_regions"][y][cr][j][0]);
                   var ev = r.children[1].children[0]; ev.value = vObj["countries_regions"][y][cr][j][1]
                   var ev = r.children[2].children[0]; ev.value = vObj["countries_regions"][y][cr][j][2]
                   var ev = r.children[3].children[0]; ev.value = vObj["countries_regions"][y][cr][j][3]
                   var ev = r.children[4].children[0]; ev.value = vObj["countries_regions"][y][cr][j][4]
                   var ev = r.children[5].children[0]; ev.value = vObj["countries_regions"][y][cr][j][5]
                  n_ += 1;
                }
            } else if (cr == "regions")
            {
                var r = document.getElementById("rp_region_row")
                var n_ = 0
                for (j in vObj["countries_regions"][y][cr])
                {
                  //alert(y + "  " + cr + " : " + j+ "      " + vObj["countries_regions"][y][cr][j])
                  var elm = document.getElementById("regions_"); elm.checked = true;
                  if(n_!=0)
                  {
                   r = add_region_risk_premium();
                  }
                   var e = r.children[0].children[0]; e.value = j;
                   e.setAttribute("rec_id", vObj["countries_regions"][y][cr][j][0]);
                   var ev = r.children[1].children[0]; ev.value = vObj["countries_regions"][y][cr][j][1]
                   var ev = r.children[2].children[0]; ev.value = vObj["countries_regions"][y][cr][j][2]
                   var ev = r.children[3].children[0]; ev.value = vObj["countries_regions"][y][cr][j][3]
                   var ev = r.children[4].children[0]; ev.value = vObj["countries_regions"][y][cr][j][4]
                   var ev = r.children[5].children[0]; ev.value = vObj["countries_regions"][y][cr][j][5]
                  n_ += 1;
                }
            }
        }
        var evt = new Event("click", {bubbles: true});elm.dispatchEvent(evt);
  }}
  calc_rp_();
}
</script>


<!-- Pick Company and year of valuation-->
<!-- ticker_onchange(event) -->
<script>
function ticker_onchange(event)
{
  var search_ticker = event.target.value
  // alert(search_ticker)
  elm = document.getElementById("companies")
  value_ = -1
  for (var i = 0; i < elm.children.length; i++)
  {
   e = elm.children[i]
   ticker_ = e.getAttribute("ticker")
   if(search_ticker.toLowerCase() == ticker_.toLowerCase())
   {
    value_ = e.getAttribute("value")
   }
  }
  if (value_ == -1)
  {
    alert("We do not provide data for this company.");  return;
    $.post('{% url "corporatevaluation:create_company_by_ticker" %}',
          {
            ticker: search_ticker.toUpperCase(),
          },
          function(data){

         // alert(data['status']);
         // alert(data['id']);
         // alert(data['company_name']);

            var option = document.createElement("option");
            //alert(option.outerHTML)
            option.text = data['company_name'];
            option.value = data['id'];
            option.ticker = search_ticker.toUpperCase();

            //alert(option.outerHTML)
            elm.add(option);
            value_ = data['id']
            elm = document.getElementById("companies")
            elm.value = value_;
            var evt = new Event("change", {bubbles: true});elm.dispatchEvent(evt);
        });
  } else
  {
    elm.value = value_;
    var evt = new Event("change", {bubbles: true});elm.dispatchEvent(evt);
  }
}

</script>

<!-- rp_input_(event) -->
<script>
function rp_input_(event, r="null", region="false")
{
if (r!="null"){var e=r}
else{var e = event.target.parentNode.parentNode;}
 c = e.children[0].children[0].value;
 id = e.children[0].children[0].getAttribute("rec_id");
 re = e.children[1].children[0].value;
 ra = e.children[2].children[0].value;
 sp = e.children[3].children[0].value;
 rp = e.children[4].children[0].value;
 tx = e.children[5].children[0].value;
  $.post('{% url "corporatevaluation:update_country_risk" %}',
  {
    rg: region,
    y: vObj["valuation_year"],
    t: vObj["ticker"],
    id: id,
    c: c,
    re:re ,
    ra:ra ,
    sp:sp ,
    rp:rp ,
    tx:tx ,
  },
  function(data){
    try{
    // alert(data['status']);
        e.children[0].children[0].setAttribute("rec_id", data['id'])
        //alert(e.outerHTML)
    }
    catch(err){alert(22)};
  });
}
</script>

<!--calc_rp_(event)  -->
<script>
function calc_rp_()
{
  // -- country --
  var elm = document.getElementById("rp_countries_tbody_");
  var rev = 0; var n_ds = 0;var n_rp = 0;var n_tx = 0;
  for (i = 0; i < elm.children.length; i++) {
  try{
    rev += 1*elm.children[i].children[1].children[0].value;
    n_ds += elm.children[i].children[1].children[0].value * elm.children[i].children[3].children[0].value;
    n_rp += elm.children[i].children[1].children[0].value * elm.children[i].children[4].children[0].value;
    n_tx += elm.children[i].children[1].children[0].value * elm.children[i].children[5].children[0].value;
    } catch (er){alert(er)}
  }
  var ds = document.getElementById("rp_default_spread_avg");
  var rp = document.getElementById("rp_risk_premium_avg");
  var tx = document.getElementById("rp_tax_rate_avg");
  ds.innerHTML = parseFloat(n_ds/rev).toFixed(2);rp.innerHTML = parseFloat(n_rp/rev).toFixed(2); tx.innerHTML = parseFloat(n_tx/rev).toFixed(2);

  // -- region --
  var elm = document.getElementById("rp_regions_tbody_");
  var rev = 0; var n_ds = 0;var n_rp = 0;var n_tx = 0;
  for (i = 0; i < elm.children.length; i++) {
  try{
    rev += 1*elm.children[i].children[1].children[0].value;
    n_ds += elm.children[i].children[1].children[0].value * elm.children[i].children[3].children[0].value;
    n_rp += elm.children[i].children[1].children[0].value * elm.children[i].children[4].children[0].value;
    n_tx += elm.children[i].children[1].children[0].value * elm.children[i].children[5].children[0].value;
    } catch (er){alert(er)}
  }
  var ds = document.getElementById("rpr_default_spread_avg");
  var rp = document.getElementById("rpr_risk_premium_avg");
  var tx = document.getElementById("rpr_tax_rate_avg");
  ds.innerHTML = parseFloat(n_ds/rev).toFixed(2);rp.innerHTML = parseFloat(n_rp/rev).toFixed(2); tx.innerHTML = parseFloat(n_tx/rev).toFixed(2);
}
</script>

<!-- valuation_year_fun(event) -->
<script>
function valuation_year_fun(event)
{
  //alert('valuation_year_fun 1');
  e = event.target; value = e.options[e.selectedIndex].value; vObj["valuation_year"] = value;

    // need to open this:
    // need to open this:
    // need to open this:

    try{get_countries_regions_for_year();} catch(er){}
    // calculate_all()

    // need to open this:
    // need to open this:
    // need to open this:
};
</script>

<!-- countries_fun(event) -->
<script>
function countries_fun(event)
{
 var elm = event.target; var eo = elm.options[elm.selectedIndex]; var value = eo.getAttribute('data')
 //alert(elm.getAttribute("rec_id"))
 var s = value.split("_");
 var r = elm.parentNode.parentNode
 //alert(r.outerHTML)
  //--
  //vObj["country_tax_rate"] = s[0]*100
  //vObj["country_rating"] = s[1]
  //vObj["country_default_spread"] = s[2]*100
  //--
  r.children[2].children[0].value = s[1]
  r.children[3].children[0].value = s[2]
  r.children[4].children[0].value= s[3]
  r.children[5].children[0].value = s[0]
 //alert(r.outerHTML)
 // document.getElementById('cofe_ads').innerHTML = s[2]
 // document.getElementById('marginal_tax_rate_').value = s[0]
 // calculate_all()
}
</script>

<!-- regions_fun(event) -->
<script>
function regions_fun(event)
{
 //alert("regions")
 var elm = event.target; var eo = elm.options[elm.selectedIndex]; var value = eo.getAttribute('data')
 alert(elm.getAttribute("rec_id"))
 var s = value.split("_");
 var r = elm.parentNode.parentNode

 //alert(s)
 //alert(r.outerHTML)

  //--
  //vObj["country_tax_rate"] = s[0]*100
  //vObj["country_rating"] = s[1]
  //vObj["country_default_spread"] = s[2]*100
  //--

  r.children[2].children[0].value = s[1]
  r.children[3].children[0].value = s[2]
  r.children[4].children[0].value= s[3]
  r.children[5].children[0].value = s[0]

 //alert(r.outerHTML)

 // document.getElementById('cofe_ads').innerHTML = s[2]
 // document.getElementById('marginal_tax_rate_').value = s[0]
 // calculate_all()
}
</script>

<!-- clean_rp_for_country_or_region(event) -->
<script>
function clean_rp_for_country_or_region(event)
{
  var elm = document.getElementById("rp_countries_tbody_");
  while (elm.children.length > 1) {
  var n_= elm.children.length-1;elm.removeChild(elm.children[n_]); var elm = document.getElementById("rp_countries_tbody_");}

  var elm = document.getElementById("rp_regions_tbody_")
  while (elm.children.length > 1) {
  var n_= elm.children.length-1;elm.removeChild(elm.children[n_]); var elm = document.getElementById("rp_regions_tbody_")
  }
   // calculate_all()
}
</script>

<!-- delete_rp_for_country_or_region(event) -->
<script>
function delete_rp_for_country_or_region(event)
{
 t = event.target
 r = t.parentNode.parentNode.parentNode;
 r.children[0].children[0].value = -1;
 rp_input_(event=event, r=r)

 //alert("r\n" + r.outerHTML)
 //alert("r.parentNode\n" + r.parentNode.outerHTML)
 //alert(r.parentNode.children.length)
 if(r.parentNode.children.length > 1)
 {
   r.parentNode.removeChild(r);
 }
 calc_rp_()
 calculate_all()
}
</script>

<!-- add_country_risk_premium() -->
<script>
function add_country_risk_premium()
{
    t = document.getElementById("rp_countries_tbody_")
    r = document.getElementById("rp_country_row")
    var c = r.cloneNode(true);

    var e = c.children[0].children[0]; e.value = -1;
    e.setAttribute("rec_id", "-1");
    t.appendChild(c);
    // calculate_all()
    return c;
}
</script>

<!-- add_region_risk_premium() -->
<script>
function add_region_risk_premium()
{
    t = document.getElementById("rp_regions_tbody_")
    r = document.getElementById("rp_region_row")
    var c = r.cloneNode(true);
    var e = c.children[0].children[0]; e.value = -1;
    e.setAttribute("rec_id", "-1");
    t.appendChild(c);
    // calculate_all()
    return c;
}
</script>

<!-- set_data(data) It is pulling data from FinDynamics-->
<script>
function set_data(data)
{
    vObj["sic_code"] = data['sic_code']; vObj["sic_description"] = data['sic_description'];
    //document.getElementById('ticker_').innerHTML = data['ticker'];
    document.getElementById('sic_code_').value = data['sic_code'];
    document.getElementById('industries').value = data['sic_code'];
    document.getElementById('countries').value = data['country_id'];
    // -----------
    cd = data['company_data']; vObj["cd"] = cd;
    sy = "<thead><tr id='fs_years_data'><th>Account</th>"
    z = 0;
    for (y in cd)
    {z += 1;
     if(z==1)
     {for (a in cd[y]){s = a + "= \"<tr><td class='account'>"+cd[y][a][1]+"</td>\""; eval(s);}}
     sy += "<th><a id='xbrl_data_"+y+"' href='#'>"+y+"</th>"
     for (a in cd[y]){s = a + "+= get_account('"+a+"', y, cd)"; eval(s);}
    }
    st = "<table id='data'>"+sy+"</tr></thead>";
    ss = "";
    for (a in cd[y]) {ss += "st+=" + a + " + '</tr>'; "}
    eval(ss)
    st += "</table><br/><br/><br/><br/><br/>";
    s_yf_http = "https:\/\/finance.yahoo.com\/quote\/" + data['ticker'] + "\/financials?p=" + data['ticker']
    st='<div><a id="fy_link" href="'+ s_yf_http +'" target="_blank"> Yahoo Finance</a></div><br/>'+st;
    sm.TabObjects["data"].tabDoc.innerHTML = st
}
</script>

<!-- companies_fun(event) -->
<script>
function companies_fun(event)
{
  try{clean_rp_for_country_or_region();} catch(er){}
  e = event.target; id_ = e.options[e.selectedIndex].value; ticker_ = e.options[e.selectedIndex].getAttribute("ticker");
  document.getElementById('search_ticker').value = ticker_;
  //alert(ticker_); //alert(id_)
  vObj["ticker"] = ticker_; vObj["accounts_chosen"] = [];

  // From FinDynamic
  $.post('{% url "corporatevaluation:get_company_detail" %}',
  {
    id: id_,
  },
  function(data){
    vObj["sec_company_data"][id_] = data;
    // in this tab
    try{ set_data(data);}
    catch(err){sm.TabObjects["data"].tabDoc.innerHTML = "We did not collect data from FinDynamic. Downloading data from SEC."};
    // var event = new Event("change", {bubbles: true});
    // document.getElementById('countries').dispatchEvent(event);
  });

     // From our system of data collection
     if(!vObj["sec_company_data"][ticker_]){vObj["sec_company_data"][ticker_]={}}
     console.log("get_data_ticker: ", "before post get_data_ticker");
     if(vObj["sec_company_data"][ticker_]['company_info'])
     {
        process_get_data_ticker(vObj["sec_company_data"][ticker_]['company_info'])
     } else {
         $.post('{% url "corporatevaluation:get_data_ticker" %}',
          {
            ticker: ticker_,
            accounting_principle: 'us-gaap',
            is_update : vObj["is_update"],
          },
          function(data){
                process_get_data_ticker(data)
                vObj["sec_company_data"][ticker_]['company_info'] = data
          });
     }
        console.log("get_data_ticker: ", "in post get_data_ticker 55")
}
</script>

<!-- process_get_data_ticker(data) -->
<script>
function process_get_data_ticker(data)
{
    // --------------
    var d = document.getElementById('valuationsetup_xbrl_data')
    console.log("get_data_ticker: ", "in post get_data_ticker 1")
    vObj["company_info"] = data['company_info'];
    vObj["countries_regions"] = data['countries_regions'];
    vObj["regions_of_operations"] = data['regions_of_operations'];
    if (!data['data']){alert("There is no data for this company."); return;}

    vObj["xbrl_data"] = data['data'];
    vObj["xbrl_statements"] = data['statements']

    //alert(vObj["xbrl_data"]['2020']['dei']['entityregistrantname'])
    // -- in _xbrl_data
      xbrl_set_data()
    // --
    sv = '<table><tr id="fs_years_data_sec">'
    console.log("get_data_ticker: ", "in post get_data_ticker 2")
    for (y in vObj["xbrl_data"])
    {
         console.log("get_data_ticker year: ", "in post get_data_ticker 20: ", y)
         try{var ry = vObj["xbrl_data"][y]['dei']['documentfiscalyearfocus'];} catch(er){var ry=''}
         console.log("process_get_data_ticker: ", "in post get_data_ticker 22", y)

         //if(!ry){ry=''}
         // get_xbrl_view is in
         sv += '<td><a href="#" onclick="get_xbrl_view(event)" '
         try{
            var y_view_link = vObj["xbrl_data"][y]['view_link'];
            sv += 'view_link="'+ y_view_link + '" ';
           } catch (er){sv += 'view_link="" ';}
         //if(y_view_link){ sv += 'view_link="'+ y_view_link + '" '}
         //else{ sv += 'view_link="" ' }

         console.log("process_get_data_ticker: ", "in post get_data_ticker 24", y)
         try{ var y_r_link = vObj["xbrl_data"][y]['r_link']; sv += 'r_link="' + y_r_link + '" ';}
         catch(er){sv += 'r_link="" ';}
         console.log("process_get_data_ticker: ", "in post get_data_ticker 26", y)

         // if(y_r_link) { sv += 'r_link="' + y_r_link + '" '} else{sv += 'r_link="" '}

         sv += 'filing_year="' + y + '" style="color:blue">' + ry + '</a></td>'
         try{
             var t = document.getElementById("xbrl_data_"+ry)
             t.setAttribute("view_link", vObj["xbrl_data"][y]['view_link'])
             t.setAttribute("r_link", vObj["xbrl_data"][y]['r_link'])
             t.setAttribute("filing_year", y)
             t.setAttribute("style", "color:white")
             //alert(t.outerHTML)
            } catch (er) {
                console.log("get_data_ticker: ", "in post error get_data_ticker 100: ", y, er)
         }
         console.log("process_get_data_ticker: ", "in post get_data_ticker 28", y)
         try{
             var tx = document.getElementById("sec_xbrl_data_"+ry)
             tx.setAttribute("view_link", vObj["xbrl_data"][y]['view_link'])
             tx.setAttribute("href", vObj["xbrl_data"][y]['view_link'])
             tx.setAttribute("r_link", vObj["xbrl_data"][y]['r_link'])
             tx.setAttribute("filing_year", y)
             tx.setAttribute("style", "color:white")
             //alert(t.outerHTML)
            } catch (er) {
                console.log("get_data_ticker: ", "in post error get_data_ticker 200: ", y, er)
         }
     }

    console.log("process_get_data_ticker: ", "in post get_data_ticker 50")
        sv += '</tr></table>'
    console.log("process_get_data_ticker: ", "in post get_data_ticker 52")
        d.innerHTML = sv
    console.log("process_get_data_ticker: ", "in post get_data_ticker 54")
        //alert(d.outerHTML)

    // -- in _xbrl_data tab --
    try{ balance_accounts()} catch (er) {alert("not all balances were calculated:" + er)}
    //alert(101)
    console.log("process_get_data_ticker: ", "in post get_data_ticker 56")
    // -- in fsa tab -
    //alert(102)
    try{ ratio_analysis()} catch (er) {alert("not all ratios were calculated:" + er)}
    console.log("process_get_data_ticker: ", "in post get_data_ticker 58")
    // --
    //alert(1021)

    // need to open this:
    // need to open this:
    // need to open this:
    //
    try{get_countries_regions_for_year();} catch(er){}
      // calculate_all()

    // need to open this:
    // need to open this:
    // need to open this:
    //alert(103)
    // --
}


</script>

<!-- sic_code_onchange(event) -->
<script>
function sic_code_onchange(event)
{
    var value = event.target.value; elm = document.getElementById("industries");
    value_ = -1;
    for (var i = 0; i < elm.children.length; i++)
    {
      var e = elm.children[i]; var value_e = e.getAttribute("value");
      if(value.toLowerCase() == value_e.toLowerCase()){var value_ = e.getAttribute("value")};
    }
    if (value_ == -1)
    {alert("We do not provide data for this industry.");  return;} else
    {elm.value = value_;var evt = new Event("change", {bubbles: true});elm.dispatchEvent(evt);}
}
</script>

<!-- industries_fun_(value) -->
<script>
function industries_fun_(value)
{
  var sic_code_ = value;  vObj["sic_code"] = value;  document.getElementById("sic_code_").value = value;
    $.post('{% url "corporatevaluation:get_industry_detail" %}',
      {
        sic_code: sic_code_,
      },
      function(data){
        var output = document.getElementById("companies")
        output.innerHTML = '';
        var ss = data["status"]
        arr = ss.split("[+]")
        //alert(arr[1])

        for ( kk in arr)
        {
            //alert(arr[kk])
            ar = arr[kk].split(";")
            //alert(ar[0])
            //alert(ar[1])

            var option = document.createElement("option");
            //alert(option.outerHTML)
            option.text = ar[1];
            option.value = ar[0];
            //alert(option.outerHTML)
            output.add(option);
        }
        //alert(output.outerHTML)
      }
    );
}

function industries_fun(event)
{
  e = event.target
  value = e.options[e.selectedIndex].value
  industries_fun_(value)
}
</script>

<!--  create_valuation_year()  -->
<script>
// create list of years for valuation
// ----------------------------------
function create_valuation_year()
{
    var output = document.getElementById("valuation_year")
    this_year = new Date().getFullYear();
    this_year -= 1
    vObj["valuation_year"] = this_year
    var option = document.createElement("option");
    for(var i = this_year; i > 2016 ; i--)
    {
        var option = document.createElement("option");
        option.text = i;
        option.value = i;
        output.add(option);
    }
    output.value = this_year
    vObj["short_number_of_years"] = 1*document.getElementById("duration_of_st_period_").value
}
</script>
